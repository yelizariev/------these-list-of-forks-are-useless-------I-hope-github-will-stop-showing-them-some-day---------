<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Work+Sans:500,600" rel="stylesheet">
  
    <title>Покупки в приложении &#8212; Документация odoo 13.0</title>
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/patchqueue.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="../_static/jquery.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap.js"></script>
    <script type="text/javascript" src="../_static/doc.js"></script>
    <script type="text/javascript" src="../_static/jquery.noconflict.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/patchqueue.js"></script><link rel="canonical" href="" />
  
    <link rel="index" title="Алфавитный указатель" href="../genindex.html" />
    <link rel="search" title="Поиск" href="../search.html" />
    <link rel="next" title="Обновление базы данных" href="upgrade.html" />
    <link rel="prev" title="Внешний API" href="odoo.html" /> 
  </head><body><header class="o_main_header o_has_sub_nav o_inverted ">
<!-- 
    <div class="o_main_header_main">
      <a class="pull-left o_logo" href="/"></a>
      <a href="#" class="o_mobile_menu_toggle visible-xs-block pull-right">
        <span class="sr-only">Toggle navigation</span>
        <span class="mdi-navigation-menu"></span>
      </a>
      <div class="o_header_buttons">
        <a href="http://www.odoo.com/trial" class="btn btn-primary">Start Now</a>
      </div>
      <ul class="o_primary_nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle">Apps</a>
          <div class="dropdown-menu o_secondary_nav">
            <div class="container">
              <div class="row">
                <div class="col-sm-3 o_website_apps">
                  <div class="o_nav_app_family">
                    <span></span> Websites
                    <div>Build great user experience</div>
                  </div>
                  <ul>
                    <li><a href="https://www.odoo.com/page/website-builder">Website Builder</a></li>
                    <li><a href="https://www.odoo.com/page/e-commerce">eCommerce</a></li>
                    <li><a href="https://www.odoo.com/page/blog-engine">Blogs</a></li>
                    <li><a href="https://www.odoo.com/page/community-builder">Forums</a></li>
                    <li><a href="https://www.odoo.com/page/slides">Slides</a></li>
                    <li><a href="https://adspike.odoo.com">SEA</a></li>
                  </ul>
                </div>
                <div class="col-sm-3 o_sale_apps">
                  <div class="o_nav_app_family">
                    <span></span> Sales
                    <div>Boost your success rate</div>
                  </div>
                  <ul>
                    <li><a href="https://www.odoo.com/page/sales">Sales</a></li>
                    <li><a href="https://www.odoo.com/page/crm">CRM</a></li>
                    <li><a href="https://www.odoo.com/page/billing">Invoicing</a></li>
                    <li class="dropdown">
                      <a href="#0" class="dropdown-toggle">Point of Sale</a>
                      <ul>
                        <li><a href="https://www.odoo.com/page/point-of-sale">Shops</a></li>
                        <li><a href="https://www.odoo.com/page/pos-restaurant">Restaurants</a></li>
                      </ul>
                    </li>
                    <li><a href="https://www.odoo.com/page/subscriptions">Subscriptions</a></li>
                    <li><a href="https://www.odoo.com/page/sign">Sign</a></li>
                  </ul>
                </div>
                <div class="col-sm-3 o_operation_apps">
                  <div class="o_nav_app_family">
                    <span></span> Operations
                    <div>It's all about efficiency</div>
                  </div>
                  <ul>
                    <li><a href="https://www.odoo.com/page/accounting">Accounting</a></li>
                    <li><a href="https://www.odoo.com/page/project-management">Project</a></li>
                    <li class="dropdown">
                      <a href="#0" class="dropdown-toggle">Human Resources</a>
                      <ul>
                        <li><a href="https://www.odoo.com/page/recruitment">Recruitment</a></li>
                        <li><a href="https://www.odoo.com/page/employees">Employees</a></li>
                        <li><a href="https://www.odoo.com/page/expenses">Expenses</a></li>
                        <li><a href="https://www.odoo.com/page/appraisal">Appraisal</a></li>
                        <li><a href="https://www.odoo.com/page/fleet">Fleet</a></li>
                        <li><a href="https://www.odoo.com/page/leaves">Leaves</a></li>
                      </ul>
                    </li>
                    <li><a href="https://www.odoo.com/page/warehouse">Inventory</a></li>
                    <li><a href="https://www.odoo.com/page/purchase">Purchase</a></li>
                    <li class="dropdown">
                      <a href="#0" class="dropdown-toggle">Manufacturing</a>
                      <ul>
                        <li><a href="https://www.odoo.com/page/manufacturing">MRP</a></li>
                        <li><a href="https://www.odoo.com/page/plm">PLM</a></li>
                        <li><a href="https://www.odoo.com/page/maintenance">Maintenance</a></li>
                        <li><a href="https://www.odoo.com/page/quality">Quality</a></li>
                      </ul>
                    </li>
                  </ul>
                </div>
                <div class="col-sm-3 o_productivity_apps">
                  <div class="o_nav_app_family">
                    <span></span> Productivity Tools
                    <div>Great Tools = Happy People</div>
                  </div>
                  <ul>
                    <li class="dropdown">
                      <a href="#0" class="dropdown-toggle">Communication</a>
                      <ul>
                        <li><a href="https://www.odoo.com/page/discuss">Discuss</a></li>
                        <li><a href="https://www.odoo.com/page/discuss-groups">Mailing Lists</a></li>
                        <li><a href="https://www.odoo.com/page/notes">Notes</a></li>
                        <li><a href="#">Help desk</a></li>
                        <li><a href="#">Appointment</a></li>
                      </ul>
                    </li>
                    <li><a href="https://www.odoo.com/page/timesheet">Timesheet</a></li>
                    <li><a href="https://www.odoo.com/page/email-marketing">Email Marketing</a></li>
                    <li><a href="https://www.odoo.com/page/events">Events</a></li>
                    <li><a href="https://www.odoo.com/page/survey">Survey</a></li>
                    <li><a href="https://www.odoo.com/page/live-chat">Live Chat</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <a href="http://www.odoo.com/apps/modules" class="o_store_link"><i class="fa fa-cube fa-fw"></i> Third party apps</a>
          </div>
        </li>
        <li><a href="https://www.odoo.com/page/tour">Tour</a></li>
        <li><a href="https://www.odoo.com/pricing">Pricing</a></li>
        <li><a href="https://www.odoo.com/page/docs">Docs</a></li>
      </ul>
    </div>
-->
    <nav class="navbar o_sub_nav">
      <div class="container">
        <div class="navbar-header visible-xs">
            <button type="button" class="navbar-toggle collapsed text-left btn-block" data-toggle="collapse" data-target="#o_sub-menu" aria-expanded="false">
              Navigate
              <span class="mdi-hardware-keyboard-arrow-down pull-right"></span>
            </button>
        </div>

        <div class="collapse navbar-collapse" id="o_sub-menu">
          <ol class="o_breadcrumb breadcrumb nav navbar-left">
              
              





    
        
            <li><a href="../index.html">Developer Doc</a></li>
        
    
    <li class="active"><a href="#">Покупки в приложении</a></li>

              
          </ol>

          <div class="call-to-action navbar-right hidden-xs">
            <a href="http://www.odoo.com/trial" class="btn btn-primary">Start Now</a>
          </div>

          <ul class="navbar-nav navbar-right nav o_sub_nav_actions">
            
              <li class="divider"></li>
            

            
            


            
          </ul>

          <ul class="nav navbar-nav navbar-right">
            

            
            
<!--
<li><a href="https://www.odoo.com/documentation/user/13.0/index.html">User</a></li>
<li><a href="https://www.odoo.com/documentation/13.0/index.html">Developer</a></li>
<li><a href="https://www.odoo.com/documentation/13.0/setup/install.html">Installation</a></li>
<li><a href="https://odoo.com/slides">eLearning</a></li>
<li><a href="https://www.odoo.com/page/odoo-white-paper">White Papers</a></li>
<li><a href="https://www.odoo.com/page/legal">Legal</a></li>
-->
            

            
          </ul>
        </div>
      </div>
    </nav>
  </header><div id="wrap" class="">
    
    
    
    <figure class="card top has_banner">
      <span class="card-img" style="background-image: url('../_static/banners/iap.jpg');"></span>
      <div class="container text-center">
        <h1> Покупки в приложении </h1>
      </div>
    </figure>
    
    
    
      <main class="container ">
        
        <div class="o_content row">
          
          <aside>
            <div class="navbar-aside text-center">
              <ul class="nav list-group text-left"><li class="list-group-item"><a href="#overview" class="reference internal ripple">обзор</a></li><li class="list-group-item"><a href="#building-your-service" class="reference internal ripple">Создание вашего сервиса</a><ul ><li class="list-group-item"><a href="#register-the-service-on-odoo" class="reference internal ripple">Зарегистрируйте сервис на Odoo</a></li><li class="list-group-item"><a href="#packs" class="reference internal ripple">пакеты</a></li><li class="list-group-item"><a href="#odoo-app" class="reference internal ripple">Приложение Odoo</a></li><li class="list-group-item"><a href="#service" class="reference internal ripple">обслуживание</a></li></ul></li><li class="list-group-item"><a href="#json-rpc2-transaction-api" class="reference internal ripple">JSON-RPC2 Транзакция API</a><ul ><li class="list-group-item"><a href="#authorize" class="reference internal ripple">Авторизоваться</a></li><li class="list-group-item"><a href="#capture" class="reference internal ripple">Захватить</a></li><li class="list-group-item"><a href="#cancel" class="reference internal ripple">Отмена</a></li><li class="list-group-item"><a href="#types" class="reference internal ripple">Типы</a></li><li class="list-group-item"><a href="#test-the-api" class="reference internal ripple">Протестируйте API</a></li></ul></li><li class="list-group-item"><a href="#odoo-helpers" class="reference internal ripple">Помощники Odoo</a><ul ><li class="list-group-item"><a href="#charging" class="reference internal ripple">Зарядка</a></li><li class="list-group-item"><a href="#id1" class="reference internal ripple">Авторизоваться</a></li><li class="list-group-item"><a href="#id2" class="reference internal ripple">Отмена</a></li><li class="list-group-item"><a href="#id3" class="reference internal ripple">Захватить</a></li></ul></li></ul>
              
              <p class="gith-container"><a href="https://github.com/odoo/odoo/edit/13.0/doc/webservices/iap.rst" class="gith-link">
                  Edit on GitHub
              </a></p>
              
            </div>
          </aside>
          
          <article class="doc-body ">
            
            
  <section id="in-app-purchase"><p >In-App Purchase (IAP) позволяет поставщикам текущих услуг через приложения Odoo получать компенсацию за постоянное использование сервиса, а не - и, возможно, вместо - единственной первоначальной покупки.</p><p >В этом контексте Odoo действует в основном как * посредник * между клиентом и разработчиком приложений Odoo:</p><ul ><li >Пользователи покупают сервисные токены от Odoo.</li><li >Поставщики услуг получают токены из учетной записи Odoo пользователя, когда запрашивается услуга.</li></ul><div role="alert" class="alert alert-warning"><h3 class="alert-title">Внимание</h3><p >Этот документ предназначен для * поставщиков услуг * и представляет последнее, что может быть сделано либо через прямой <a href="https://www.jsonrpc.org/specification" class="external reference alert-link">JSON-RPC2</a>, либо, если вы используете Odoo, используя вспомогательные вспомогательные средства, которые он предоставляет.</p></div></section><section id="overview"><h2 >обзор</h2><div id="id5"><img src="../_images/players.png" class="center-block img-responsive"><h4 >Игроки</h4><ul ><li >Поставщик услуг (вероятно) является вашим читателем, вы будете предоставлять ценность для клиента в форме услуги, оплачиваемой за использование.</li><li >Клиент установил ваше приложение Odoo, и оттуда будет запрашивать услуги.</li><li >Кредитование брокеров Odoo, Клиент добавляет кредит на свой счет, и вы можете получать оттуда кредиты для оказания услуг.</li><li >Внешняя служба является дополнительным игроком: * вы * можете либо предоставлять службу напрямую, либо вы можете делегировать реальную службу, выступающую в качестве моста / переводчика, между системой Odoo и реальной службой.</li></ul></div><div id="id6"><img src="../_images/credits.jpg" class="center-block img-responsive"><h4 >Кредиты</h4></div><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><p >Кредиты перешли от целого числа к плавающей стоимости, начиная с ** октября 2018 года <a href="#id1"><span id="id2" class="problematic">**</span></a>. Целочисленные значения по-прежнему поддерживаются.</p><p >Каждый сервис, предоставляемый через платформу IAP, может использоваться клиентами с токенами или * кредитами <a href="#id1"><span id="id2" class="problematic">*</span></a>. Кредиты являются плавающей единицей, и их денежная стоимость зависит от услуги и определяется поставщиком. Это могло быть:</p><ul ><li >за услугу смс: 1 кредит = 1 смс;</li><li >для рекламного сервиса: 1 кредит = 1 объявление; или</li><li >за почтовые услуги: 1 кредит = 1 почтовая марка.</li></ul><p >Кредит также может быть просто связан с фиксированной суммой денег, чтобы смягчить колебания цены (например, цены на смс и марки могут варьироваться в зависимости от страны).</p><p >Стоимость кредитов фиксируется с помощью предоплаченных кредитных пакетов, которые клиенты могут купить на <a href="https://iap.odoo.com" class="external reference alert-link">https://iap.odoo.com</a> (см . <a href="#iap-packages" class="alert-link reference internal"><span class="std std-ref">Packs</span></a>).</p></div><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><p >В следующих пояснениях мы будем игнорировать внешнюю службу, они являются лишь частью предоставляемой вами услуги.</p></div><div id="id7"><img src="../_images/normal.png" class="center-block img-responsive"><h4 >«Нормальный» поток обслуживания</h4><p >Если все идет хорошо, нормальный поток выглядит следующим образом:</p><ol ><li >Клиент запрашивает какую-либо услугу.</li><li >Поставщик услуг спрашивает Odoo, достаточно ли кредитов для данной услуги на счете Клиента, и создает транзакцию на эту сумму.</li><li >Поставщик услуг предоставляет услугу (самостоятельно или с помощью внешних служб).</li><li >Поставщик услуг возвращается к Odoo для захвата (если услуга может быть предоставлена) или отмены (если услуга не может быть предоставлена) транзакции, созданной на шаге 2.</li><li >Наконец, Поставщик услуг уведомляет Клиента о том, что услуга была оказана, возможно (в зависимости от услуги), отображая или сохраняя свои результаты в системе клиента.</li></ol></div><div id="id8"><img src="../_images/no-credit.png" class="center-block img-responsive"><h4 >Недостаточно кредитов</h4><p >Однако, если на счете Клиента отсутствуют кредиты на услугу, поток будет следующим:</p><ol ><li >Клиент запрашивает услугу, как и ранее.</li><li >Поставщик услуг спрашивает Odoo, достаточно ли кредитов на счете Клиента, и получает отрицательный ответ.</li><li >Это сигнализируется обратно Клиенту.</li><li >Кто перенаправлен на свою учетную запись Odoo, чтобы пополнить счет и повторить попытку.</li></ol></div></section><section id="building-your-service"><h2 >Создание вашего сервиса</h2><p >Для этого примера мы предоставим сервис ~~ майнинг доджойнс ~~, сжигающий 10 секунд процессора за кредит. Например, вы можете:</p><ul ><li >обеспечить онлайн-сервис самостоятельно (например, конвертировать котировки в факсы для бизнеса в Японии);</li><li >обеспечить * автономный * сервис самостоятельно (например, предоставить бухгалтерские услуги); или</li><li >выступать в качестве посредника для другого поставщика услуг (например, мост к шлюзу MMS).</li></ul></section><section id="register-the-service-on-odoo"><i id="register-service"></i><h3 >Зарегистрируйте сервис на Odoo</h3><p >Первым шагом является регистрация вашей службы на конечной точке IAP (производственная и / или тестовая), прежде чем вы действительно сможете запрашивать учетные записи пользователей. Чтобы создать службу, перейдите в свою * учетную запись портала * на конечной точке IAP (<a href="https://iap.odoo.com" class="external reference">https://iap.odoo.com</a> для производства, <a href="https://iap-sandbox.odoo.com" class="external reference">https://iap-sandbox.odoo.com</a> для тестирования, конечные точки * независимы * и * не синхронизировано <a href="#id1"><span id="id2" class="problematic">*</span></a>). Кроме того, вы можете перейти на свой портал на Odoo (<a href="https://iap.odoo.com/my/home" class="external reference">https://iap.odoo.com/my/home</a>) и выбрать * In-App Services <a href="#id3"><span id="id4" class="problematic">*</span></a>.</p><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><p >На производстве существует этап проверки вручную, прежде чем сервис можно будет использовать для управления реальными транзакциями. Этот шаг автоматически проходит в песочнице, чтобы облегчить тесты.</p></div><p >Войдите в систему, затем перейдите по адресу <span class="menuselection">My Account ‣ Your In-App Services</span>, нажмите` Создать <a href="#id1"><span id="id2" class="problematic">`</span></a>и предоставьте информацию о вашей службе.</p><p >Служба имеет * семь * важных полей:</p><ul ><li >: samp: <code >name</code> - <a href="#ServiceName" title="ServiceName" class="reference internal"><code class="xref py py-class">ServiceName</code></a>: это строка, которую вам нужно будет предоставить в приложении клиента <span class="xref std std-ref">app &lt;iap-odoo-app&gt;`при запросе транзакции от Odoo. (например :class:`ServiceName</span>). Как хорошая практика, это должно соответствовать техническому названию вашего приложения.</li><li >: samp: <code >label</code> - <code class="xref py py-class">Label</code>: имя, отображаемое на торговом портале для клиента.</li></ul><div role="alert" class="alert alert-warning"><h3 class="alert-title">Предупреждение</h3><p >И <a href="#ServiceName" title="ServiceName" class="alert-link reference internal"><code class="xref py py-class">ServiceName</code></a>, и <a href="#ServiceName" title="ServiceName" class="alert-link reference internal"><code class="xref py py-class">ServiceName</code></a> являются уникальными. В качестве хорошей практики: класс: <code >ServiceName</code> должен обычно соответствовать имени вашего клиентского приложения Odoo.</p></div><ul ><li >: samp: <code >icon</code> - <code class="xref py py-class">Icon</code>: универсальный значок, который будет использоваться по умолчанию для ваших пакетов <a href="#iap-packages" class="reference internal"><span class="std std-ref">packs</span></a>.</li><li >: samp: <code >key</code> - <a href="#ServiceKey" title="ServiceKey" class="reference internal"><code class="xref py py-class">ServiceKey</code></a>: ключ разработчика, который идентифицирует вас в IAP (см . <a href="#iap-service" class="reference internal"><span class="std std-ref">your service</span></a>) и позволяет получать кредиты со счета клиента. Он будет показан только один раз при создании сервиса и может быть восстановлен по желанию.</li></ul><div role="alert" class="alert alert-danger"><h3 class="alert-title">Опасно</h3><p >Ваш <a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code class="xref py py-class">ServiceKey</code></a> * является секретом <a href="#id1"><span id="id2" class="problematic">*</span></a>, утечка вашего служебного ключа позволяет другим разработчикам приложений получать кредиты, купленные за ваши услуги.</p></div><ul ><li >: samp: <code >trial credits</code> - <code class="xref py py-class">Float</code>: Это соответствует кредитам, которые вы готовы предложить при первом использовании пользователям вашего приложения. Обратите внимание, что такая услуга будет доступна только клиентам, имеющим действующий корпоративный контракт.</li><li >: samp: <code >policy policy</code> - <code class="xref py py-class">PrivacyPolicy</code>: это URL-адрес политики конфиденциальности вашего сервиса. При этом следует четко указать ** информацию, которую вы собираете <a href="#id1"><span id="id2" class="problematic">**</span></a>, как вы ее ** используете, ее актуальность ** для обеспечения работы вашего сервиса и информировать клиента о том, как они могут ** получить доступ, обновить или удалить свою личную информацию <a href="#id3"><span id="id4" class="problematic">**</span></a>.</li></ul><img src="../_images/menu.png" class="center-block img-responsive"><img src="../_images/service_list.png" class="center-block img-responsive"><img src="../_images/creating_service.png" class="center-block img-responsive"><img src="../_images/service_created.png" class="center-block img-responsive"><p >Затем вы можете создать * кредитные пакеты <a href="#id1"><span id="id2" class="problematic">*</span></a>, которые клиенты могут приобрести для использования вашего сервиса.</p></section><section id="packs"><i id="iap-packages"></i><h3 >пакеты</h3><p >Кредитный пакет по сути является продуктом с пятью характеристиками:</p><ul ><li >Название: название пакета,</li><li >Значок: конкретный значок для пакета (если он не указан, он будет отображаться на значке службы),</li><li >Описание: информация о пакете, который появится на странице магазина, а также счет,</li><li >Сумма: сумма кредитов, на которые клиент имеет право при покупке пакета,</li><li >Цена: цена в евро (пока планируется поддержка в долларах США).</li></ul><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><p >Odoo берет 25% комиссионных с продаж всех пакетов. Скорректируйте свою цену продажи соответственно.</p></div><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><p >В зависимости от стратегии цена за кредит может варьироваться от одного пакета к другому.</p></div><img src="../_images/package.png" class="center-block img-responsive"></section><section id="odoo-app"><i id="iap-odoo-app"></i><h3 >Приложение Odoo</h3><p >Вторым шагом является разработка <a href="https://www.odoo.com/apps" class="external reference">Odoo App</a>, которую клиенты могут устанавливать в своем экземпляре Odoo и с помощью которого они могут * запрашивать * предоставляемые вами услуги. Наше приложение просто добавит кнопку в форму «Партнеры», которая позволит пользователю запросить некоторое время процессора на сервере.</p><p >Сначала мы создадим модуль * odoo * в зависимости от `` iap``. IAP - это стандартный модуль V11, и эта зависимость обеспечивает правильную настройку локальной учетной записи, и у нас будет доступ к некоторым необходимым представлениям и полезным помощникам.</p><div class="pq-patch"><em >coalroller/__manifest__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="p">{</span>
</span><span class="hll">    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Coal Roller&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;Tools&#39;</span><span class="p">,</span>
</span><span class="hll">    <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;iap&#39;</span><span class="p">],</span>
</span><span class="hll"><span class="p">}</span>
</span></pre></div>
</div>
</div><em >coalroller/__init__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># -*- coding: utf-8 -*-</span>
</span></pre></div>
</div>
</div></div><p >Во-вторых, «местная» сторона интеграции. Здесь мы только добавим кнопку действия в представление партнеров, но вы, конечно, можете предоставить значительную локальную ценность через ваше приложение и дополнительные детали через удаленный сервис.</p><div class="pq-patch"><em >coalroller/__manifest__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span>    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Coal Roller&quot;</span><span class="p">,</span>
    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;Tools&#39;</span><span class="p">,</span>
    <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;iap&#39;</span><span class="p">],</span>
<span class="hll">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="hll">        <span class="s1">&#39;views/views.xml&#39;</span><span class="p">,</span>
</span><span class="hll">    <span class="p">],</span>
</span><span class="p">}</span>
</pre></div>
</div>
</div><em >coalroller/views/views.xml</em><div class="pq-section"><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;odoo&gt;</span>
</span><span class="hll">  <span class="nt">&lt;record</span> <span class="na">model=</span><span class="s">&quot;ir.ui.view&quot;</span> <span class="na">id=</span><span class="s">&quot;partner_form_coalroll&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>partner.form.coalroll<span class="nt">&lt;/field&gt;</span>
</span><span class="hll">    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;model&quot;</span><span class="nt">&gt;</span>res.partner<span class="nt">&lt;/field&gt;</span>
</span><span class="hll">    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;inherit_id&quot;</span> <span class="na">ref=</span><span class="s">&quot;base.view_partner_form&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;arch&quot;</span> <span class="na">type=</span><span class="s">&quot;xml&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">      <span class="nt">&lt;xpath</span> <span class="na">expr=</span><span class="s">&quot;//div[@name=&#39;button_box&#39;]&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;object&quot;</span> <span class="na">name=</span><span class="s">&quot;action_partner_coalroll&quot;</span>
</span><span class="hll">                <span class="na">class=</span><span class="s">&quot;oe_stat_button&quot;</span> <span class="na">icon=</span><span class="s">&quot;fa-gears&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;o_form_field o_stat_info&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;o_stat_text&quot;</span><span class="nt">&gt;</span>Roll Coal<span class="nt">&lt;/span&gt;</span>
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/button&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/xpath&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/field&gt;</span>
</span><span class="hll">  <span class="nt">&lt;/record&gt;</span>
</span><span class="hll"><span class="nt">&lt;/odoo&gt;</span>
</span></pre></div>
</div>
</div></div><img src="../_images/button.png" class="center-block img-responsive"><p >Теперь мы можем реализовать метод действия / обратный вызов. Это * вызовет наш собственный сервер <a href="#id1"><span id="id2" class="problematic">*</span></a>.</p><p >Нет требований к серверу или протоколу связи между приложением и нашим сервером, но `` iap`` предоставляет <code class="xref py py-func">jsonrpc()</code> помощник для вызова конечной точки <a href="https://www.jsonrpc.org/specification" class="external reference">JSON-RPC2</a> на другом экземпляре Odoo и прозрачно повторно вызвать соответствующие исключения Odoo ( <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="reference internal"><code class="xref py py-class">InsufficientCreditError</code></a>, <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="reference internal"><code class="xref py py-class">InsufficientCreditError</code></a> и <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="reference internal"><code class="xref py py-class">InsufficientCreditError</code></a>).</p><p >В этом звонке нам нужно будет предоставить:</p><ul ><li >любой соответствующий параметр клиента (здесь нет ни одного),</li><li >токен <code class="xref py py-class">token &lt;UserToken&gt;`текущего клиента, предоставленного полем</code> <code >account_token`</code> модели` <code >iap.account`</code>. Вы можете получить учетную запись для своей службы, вызвав: samp: <code >env [&amp;#39;iap.account&amp;#39;]. Get ({service_name})</code> где <a href="#UserToken" title="UserToken" class="reference internal"><code class="xref py py-class">token</code></a>- это имя службы, зарегистрированной в конечной точке IAP.</li></ul><div class="pq-patch"><em >coalroller/__init__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">models</span>
</span></pre></div>
</div>
</div><em >coalroller/models/__init__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">res_partner</span>
</span></pre></div>
</div>
</div><em >coalroller/models/res_partner.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">models</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">odoo.addons.iap</span> <span class="kn">import</span> <span class="n">jsonrpc</span><span class="p">,</span> <span class="n">InsufficientCreditError</span>
</span><span class="hll">
</span><span class="hll"><span class="c1"># whichever URL you deploy the service at, here we will run the remote</span>
</span><span class="hll"><span class="c1"># service in a local Odoo bound to the port 8070</span>
</span><span class="hll"><span class="n">DEFAULT_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:8070&#39;</span>
</span><span class="hll"><span class="k">class</span> <span class="nc">Partner</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class="hll">    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;res.partner&#39;</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">action_partner_coalroll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="c1"># fetch the user&#39;s token for our service</span>
</span><span class="hll">        <span class="n">user_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;iap.account&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coalroller&#39;</span><span class="p">)</span>
</span><span class="hll">        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class="hll">            <span class="c1"># we don&#39;t have any parameter to provide</span>
</span><span class="hll">            <span class="s1">&#39;account_token&#39;</span><span class="p">:</span> <span class="n">user_token</span><span class="o">.</span><span class="n">account_token</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">        <span class="c1"># ir.config_parameter allows locally overriding the endpoint</span>
</span><span class="hll">        <span class="c1"># for testing &amp; al</span>
</span><span class="hll">        <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;coalroller.endpoint&#39;</span><span class="p">,</span> <span class="n">DEFAULT_ENDPOINT</span><span class="p">)</span>
</span><span class="hll">        <span class="n">jsonrpc</span><span class="p">(</span><span class="n">endpoint</span> <span class="o">+</span> <span class="s1">&#39;/roll&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span class="hll">        <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>
</div>
</div></div><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><p >`` iap`` автоматически обрабатывает <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="alert-link reference internal"><code class="xref py py-class">InsufficientCreditError</code></a>, поступивший из действия, и предлагает пользователю добавить кредиты в свою учетную запись.</p><p ><code class="xref py py-func">jsonrpc()</code> takes care of re-raising
<a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="alert-link reference internal"><code class="xref py py-class">InsufficientCreditError</code></a> for you.</p></div><div role="alert" class="alert alert-danger"><h3 class="alert-title">Опасно</h3><p >Если вы не используете <code class="xref py py-func">jsonrpc()</code>, вы * должны * быть осторожны, чтобы повторно поднять <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="alert-link reference internal"><code class="xref py py-class">InsufficientCreditError</code></a> в своем обработчике, иначе Пользователю не будет предложено пополнить свой счет, и следующий вызов не удастся.</p></div></section><section id="service"><i id="iap-service"></i><h3 >обслуживание</h3><p >Хотя это не * требуется <a href="#id1"><span id="id2" class="problematic">*</span></a>, поскольку `` iap`` предоставляет как клиентский помощник для вызовов <a href="https://www.jsonrpc.org/specification" class="external reference">JSON-RPC2</a> ( <code class="xref py py-func">jsonrpc()</code>), так и служебный помощник для транзакций (: <a href="#odoo.addons.iap.models.iap.charge" title="odoo.addons.iap.models.iap.charge" class="reference internal"><code class="xref py py-class">charge</code></a>) мы также будем реализовывать сервисную часть в виде модуля Odoo:</p><div class="pq-patch"><em >coalroller_service/__init__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># -*- encoding: utf-8 -*-</span>
</span></pre></div>
</div>
</div><em >coalroller_service/__manifest__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="p">{</span>
</span><span class="hll">    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Coal Roller Service&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;Tools&#39;</span><span class="p">,</span>
</span><span class="hll">    <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;iap&#39;</span><span class="p">],</span>
</span><span class="hll"><span class="p">}</span>
</span></pre></div>
</div>
</div></div><p >Поскольку запрос от клиента приходит как <a href="https://www.jsonrpc.org/specification" class="external reference">JSON-RPC2</a>, нам понадобится соответствующий контроллер, который может вызвать <a href="#odoo.addons.iap.models.iap.charge" title="odoo.addons.iap.models.iap.charge" class="reference internal"><code class="xref py py-class">charge</code></a> и выполнить обслуживание в пределах:</p><div class="pq-patch"><em >coalroller_service/controllers/main.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span> <span class="nn">time</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span> <span class="nn">passlib</span> <span class="kn">import</span> <span class="n">pwd</span><span class="p">,</span> <span class="nb">hash</span>
</span><span class="hll">
</span><span class="hll"><span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">http</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">odoo.addons.iap</span> <span class="kn">import</span> <span class="n">charge</span>
</span><span class="hll">
</span><span class="hll"><span class="k">class</span> <span class="nc">CoalBurnerController</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">Controller</span><span class="p">):</span>
</span><span class="hll">    <span class="nd">@http</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/roll&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">csrf</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">roll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_token</span><span class="p">):</span>
</span><span class="hll">        <span class="c1"># the service key *is a secret*, it should not be committed in</span>
</span><span class="hll">        <span class="c1"># the source</span>
</span><span class="hll">        <span class="n">service_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;coalroller.service_key&#39;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="c1"># we charge 1 credit for 10 seconds of CPU</span>
</span><span class="hll">        <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="hll">        <span class="c1"># TODO: allow the user to specify how many (tens of seconds) of CPU they want to use</span>
</span><span class="hll">        <span class="k">with</span> <span class="n">charge</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">service_key</span><span class="p">,</span> <span class="n">account_token</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
</span><span class="hll">
</span><span class="hll">            <span class="c1"># 10 seconds of CPU per credit</span>
</span><span class="hll">            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">cost</span><span class="p">)</span>
</span><span class="hll">            <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
</span><span class="hll">                <span class="c1"># we will use CPU doing useful things: generating and</span>
</span><span class="hll">                <span class="c1"># hashing passphrases</span>
</span><span class="hll">                <span class="n">p</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">genphrase</span><span class="p">()</span>
</span><span class="hll">                <span class="n">h</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">pbkdf2_sha512</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span class="hll">        <span class="c1"># here we don&#39;t have anything useful to the client, an error</span>
</span><span class="hll">        <span class="c1"># will be raised &amp; transmitted in case of issue, if no error</span>
</span><span class="hll">        <span class="c1"># is raised we did the job</span>
</span></pre></div>
</div>
</div><em >coalroller_service/controllers/__init__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="hll"><span class="c1"># -*- encoding: utf-8 -*-</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">main</span>
</span></pre></div>
</div>
</div><em >coalroller_service/__init__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># -*- encoding: utf-8 -*-</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">controllers</span>
</span></pre></div>
</div>
</div></div><p >Помощник <a href="#odoo.addons.iap.models.iap.charge" title="odoo.addons.iap.models.iap.charge" class="reference internal"><code class="xref py py-class">charge</code></a> будет:</p><ol ><li >авторизовать (создать) транзакцию с указанным количеством кредитов, если на счету недостаточно кредитов, возникнет соответствующая ошибка</li><li >выполнить тело оператора `` with``</li><li >если тело `` with`` выполняется успешно, при необходимости обновите цену транзакции</li><li >захватить (подтвердить) транзакцию</li><li >в противном случае, если из тела `` with`` возникла ошибка, отмените транзакцию (и снимите удержание с кредитов)</li></ol><div role="alert" class="alert alert-danger"><h3 class="alert-title">Опасно</h3><p >По умолчанию <a href="#odoo.addons.iap.models.iap.charge" title="odoo.addons.iap.models.iap.charge" class="alert-link reference internal"><code class="xref py py-class">charge</code></a> связывается с конечной точкой * production * IAP, <a href="https://iap.odoo.com" class="external reference alert-link">https://iap.odoo.com</a>. При разработке и тестировании вашего сервиса вы можете указать его на конечную точку * development * IAP <a href="https://iap-sandbox.odoo.com" class="external reference alert-link">https://iap-sandbox.odoo.com</a>.</p><p >Для этого установите параметр конфигурации `` iap.endpoint`` в вашем сервисе. Odoo: в режиме отладки / разработчика, <span class="menuselection">Setting ‣ Technical ‣ Parameters ‣ System Parameters</span>, просто определите запись для ключа `` iap.endpoint``, если он еще не существует).</p></div><p >Помощник <a href="#odoo.addons.iap.models.iap.charge" title="odoo.addons.iap.models.iap.charge" class="reference internal"><code class="xref py py-class">charge</code></a> имеет два дополнительных необязательных параметра, которые мы можем использовать, чтобы сделать вещи более понятными для конечного пользователя.</p><dl ><dt >`` Description``</dt><dd >является сообщением, которое будет связано с транзакцией и будет отображаться на информационной панели пользователя. Полезно напомнить пользователю, почему существует плата.</dd><dt >`` Credit_template``</dt><dd >является именем шаблона <a href="../reference/qweb.html#reference-qweb" class="reference internal"><span class="std std-ref">Qweb</span></a>, который будет отображаться и показываться пользователю, если его учетная запись имеет меньше кредитов, чем запрашивает поставщик услуг, его цель - рассказать своим пользователям, почему они должны быть заинтересованы ваши предложения IAP.</dd></dl><div class="pq-patch"><em >coalroller_service/controllers/main.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">roll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_token</span><span class="p">):</span>
        <span class="c1"># the service key *is a secret*, it should not be committed in</span>
        <span class="c1"># the source</span>
<span class="hll">        <span class="n">service_key</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;coalroller.service_key&#39;</span><span class="p">)</span>
</span>
        <span class="c1"># we charge 1 credit for 10 seconds of CPU</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># TODO: allow the user to specify how many (tens of seconds) of CPU they want to use</span>
<span class="hll">        <span class="k">with</span> <span class="n">charge</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">service_key</span><span class="p">,</span> <span class="n">account_token</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span>
</span><span class="hll">                    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;We&#39;re just obeying orders&quot;</span><span class="p">,</span>
</span><span class="hll">                    <span class="n">credit_template</span><span class="o">=</span><span class="s1">&#39;coalroller_service.no_credit&#39;</span><span class="p">):</span>
</span>
            <span class="c1"># 10 seconds of CPU per credit</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">cost</span><span class="p">)</span>
</pre></div>
</div>
</div><em >coalroller_service/views/no-credit.xml</em><div class="pq-section"><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;odoo&gt;</span>
</span><span class="hll">  <span class="nt">&lt;template</span> <span class="na">id=</span><span class="s">&quot;no_credit&quot;</span> <span class="na">name=</span><span class="s">&quot;No credit warning&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="nt">&lt;div&gt;</span>
</span><span class="hll">      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container-fluid&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-md-7 offset-lg-1 mt32 mb32&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;h2&gt;</span>Consume electricity doing nothing useful!<span class="nt">&lt;/h2&gt;</span>
</span><span class="hll">            <span class="nt">&lt;ul&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li&gt;</span>Heat our state of the art data center for no reason<span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li&gt;</span>Use multiple watts for only 0.1€<span class="nt">&lt;/li&gt;</span>
</span><span class="hll">              <span class="nt">&lt;li&gt;</span>Roll coal without going outside<span class="nt">&lt;/li&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/ul&gt;</span>
</span><span class="hll">          <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">      <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/div&gt;</span>
</span><span class="hll">  <span class="nt">&lt;/template&gt;</span>
</span><span class="hll"><span class="nt">&lt;/odoo&gt;</span>
</span></pre></div>
</div>
</div><em >coalroller_service/__manifest__.py</em><div class="pq-section"><div class="highlight-python"><div class="highlight"><pre><span></span>    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Coal Roller Service&quot;</span><span class="p">,</span>
    <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;Tools&#39;</span><span class="p">,</span>
    <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;iap&#39;</span><span class="p">],</span>
<span class="hll">    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class="hll">        <span class="s1">&#39;views/no-credit.xml&#39;</span><span class="p">,</span>
</span><span class="hll">    <span class="p">],</span>
</span><span class="p">}</span>
</pre></div>
</div>
</div></div></section><section id="json-rpc2-transaction-api"><h2 ><a href="#json-rpc2" class="reference internal">JSON-RPC2</a> Транзакция API</h2><img src="../_images/flow.png" class="center-block img-responsive"><ul ><li >API транзакций IAP не требует использования Odoo при реализации шлюза сервера, вызовы являются стандартными <a href="https://www.jsonrpc.org/specification" class="external reference">JSON-RPC2</a>.</li><li >При вызовах используются разные * конечные точки <a href="#id1"><span id="id2" class="problematic">*</span></a>, но один и тот же * метод * на всех конечных точках (`` call``).</li><li >Исключения возвращаются как ошибки <a href="https://www.jsonrpc.org/specification" class="external reference">JSON-RPC2</a>, формальное имя исключения доступно в `` data.name`` для программных манипуляций.</li></ul></section><section id="authorize"><h3 >Авторизоваться</h3><section class="code-function"><h6 ><code>/iap/1/authorize</code></h6><p >Проверяет, что учетная запись пользователя имеет по крайней мере как «кредит», доступный * и создает удержание (ожидающая транзакция) на эту сумму <a href="#id1"><span id="id2" class="problematic">*</span></a>.</p><p >Любая сумма, удерживаемая в настоящее время в ожидании транзакции, считается недоступной для дальнейшей авторизации вызовов.</p><p >Возвращает <a href="#TransactionToken" title="TransactionToken" class="alert-link reference internal"><code class="xref py py-class">TransactionToken</code></a>, идентифицирующий ожидающую транзакцию, которая может быть использована для захвата (подтверждения) или отмены указанной транзакции.</p><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li><li ><strong >account_token</strong> (<a href="#UserToken" title="UserToken" class="alert-link reference internal"><code >UserToken</code></a>) – </li><li ><strong >credit</strong> (<a href="https://docs.python.org/3/library/functions.html#float" title="(в Python v3.8)" class="external reference alert-link"><code >float</code></a>) – </li><li ><strong >description</strong> (<a href="https://docs.python.org/3/library/stdtypes.html#str" title="(в Python v3.8)" class="external reference alert-link"><code >str</code></a>) – необязательно, помогает пользователям определить причину начислений на их счет</li><li ><strong >dbuuid</strong> (<a href="https://docs.python.org/3/library/stdtypes.html#str" title="(в Python v3.8)" class="external reference alert-link"><code >str</code></a>) – необязательно, позволяет пользователю воспользоваться пробными кредитами, если его база данных соответствует критериям (см . <a href="#register-service" class="alert-link reference internal"><span class="std std-ref">Service registration</span></a>)</li></ul></div></div><div class="code-field"><div class="code-field-name">Результат</div><div class="code-field-body"><a href="#TransactionToken" title="TransactionToken" class="alert-link reference internal"><code class="xref py py-class">TransactionToken</code></a> if the authorization succeeded</div></div><div class="code-field"><div class="code-field-name">повышения</div><div class="code-field-body"><a href="../reference/orm.html#odoo.exceptions.AccessError" title="odoo.exceptions.AccessError" class="alert-link reference internal"><code class="xref py py-class">AccessError</code></a> if the service token is invalid</div></div><div class="code-field"><div class="code-field-name">повышения</div><div class="code-field-body"><a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="alert-link reference internal"><code class="xref py py-class">InsufficientCreditError</code></a> if the account does not have enough credits</div></div><div class="code-field"><div class="code-field-name">повышения</div><div class="code-field-body">`` TypeError``, если значение `` credit`` не является целым числом или числом с плавающей точкой</div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ODOO</span> <span class="o">+</span> <span class="s1">&#39;/iap/1/authorize&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
    <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;account_token&#39;</span><span class="p">:</span> <span class="n">user_account</span><span class="p">,</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">SERVICE_KEY</span><span class="p">,</span>
        <span class="s1">&#39;credit&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;Why this is being charged&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
    <span class="c1"># handle authorize error</span>
<span class="n">tx</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>

<span class="c1"># provide your service here</span>
</pre></div>
</div>
</section><section id="capture"><h3 >Захватить</h3><section class="code-function"><h6 ><code>/iap/1/capture</code></h6><p >Подтверждает указанную транзакцию, перечисляя зарезервированные кредиты со счета пользователя поставщику услуг.</p><p >Захваты вызовов являются идемпотентными: выполнение вызовов захвата для уже захваченной транзакции не имеет никакого дальнейшего эффекта.</p><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >token</strong> (<a href="#TransactionToken" title="TransactionToken" class="alert-link reference internal"><code >TransactionToken</code></a>) – </li><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li><li ><strong >credit_to_capture</strong> (<a href="https://docs.python.org/3/library/functions.html#float" title="(в Python v3.8)" class="external reference alert-link"><code >float</code></a>) – необязательный параметр для захвата меньшего количества кредитов, чем разрешено</li></ul></div></div><div class="code-field"><div class="code-field-name">повышения</div><div class="code-field-body">: Класс: <code >~ odoo.exceptions.AccessError</code></div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="n">r2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ODOO</span> <span class="o">+</span> <span class="s1">&#39;/iap/1/capture&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
      <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span>
      <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
      <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
      <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">,</span>
          <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">SERVICE_KEY</span><span class="p">,</span>
<span class="hll">          <span class="s1">&#39;credit_to_capture&#39;</span><span class="p">:</span> <span class="n">credit</span> <span class="ow">or</span> <span class="kc">False</span><span class="p">,</span>
</span>      <span class="p">}</span>
  <span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
  <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
      <span class="c1"># handle capture error</span>
  <span class="c1"># otherwise transaction is captured</span>
</pre></div>
</div>
</section><section id="cancel"><h3 >Отмена</h3><section class="code-function"><h6 ><code>/iap/1/cancel</code></h6><p >Отменяет указанную транзакцию, освобождая удержание кредитов пользователя.</p><p >Отмена вызовов идемпотентна: выполнение вызовов захвата для уже отмененной транзакции не имеет никакого дальнейшего эффекта.</p><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >token</strong> (<a href="#TransactionToken" title="TransactionToken" class="alert-link reference internal"><code >TransactionToken</code></a>) – </li><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li></ul></div></div><div class="code-field"><div class="code-field-name">повышения</div><div class="code-field-body">: Класс: <code >~ odoo.exceptions.AccessError</code></div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">r2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ODOO</span> <span class="o">+</span> <span class="s1">&#39;/iap/1/cancel&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
    <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">tx</span><span class="p">,</span>
        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">SERVICE_KEY</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
    <span class="c1"># handle cancel error</span>
<span class="c1"># otherwise transaction is cancelled</span>
</pre></div>
</div>
</section><section id="types"><h3 >Типы</h3><p >Кроме исключений, это * абстрактные типы <a href="#id1"><span id="id2" class="problematic">*</span></a>, используемые для ясности, вам не важно, как они реализованы.</p><section class="code-class"><h6 id="ServiceName"><code><em >class </em>ServiceName</code></h6><p >Строка, идентифицирующая ваш сервис на <a href="https://iap.odoo.com" class="external reference alert-link">https://iap.odoo.com</a> (производство), а также учетную запись, связанную с вашим сервисом, в базе данных клиента.</p></section><section class="code-class"><h6 id="ServiceKey"><code><em >class </em>ServiceKey</code></h6><p >Идентификатор, сгенерированный для услуги провайдера. Каждый ключ (и сервис) соответствует токену с фиксированным значением, генерируемым сервисом.</p><p >Несколько типов токенов соответствуют нескольким сервисам. Например, SMS и MMS могут быть либо одной и той же услугой (при этом MMS «стоит» нескольких SMS), либо могут быть отдельными услугами по разным ценам.</p><div role="alert" class="alert alert-danger"><h3 class="alert-title">Опасно</h3><p >Ваш сервисный ключ * является секретным <a href="#id1"><span id="id2" class="problematic">*</span></a>, утечка сервисного ключа позволяет другим разработчикам приложений получать кредиты, купленные за ваши услуги.</p></div></section><section class="code-class"><h6 id="UserToken"><code><em >class </em>UserToken</code></h6><p >Идентификатор для учетной записи пользователя.</p></section><section class="code-class"><h6 id="TransactionToken"><code><em >class </em>TransactionToken</code></h6><p >Идентификатор транзакции, возвращаемый процессом авторизации и используемый для захвата или отмены транзакции.</p></section><section class="code-exception"><h6 id="odoo.addons.iap.models.iap.InsufficientCreditError"><code><em >exception </em>odoo.addons.iap.models.iap.InsufficientCreditError</code></h6><p >Возникает во время авторизации транзакции, если запрашиваемые кредиты в настоящее время недоступны на счете (либо недостаточно кредитов, либо слишком много ожидающих транзакций / существующих удержаний).</p></section><section class="code-exception"><h6 ><code><em >exception </em>odoo.exceptions.AccessError</code></h6><p >Был воспитан:</p><ul ><li >любая операция, для которой требуется служебный токен, если служебный токен недействителен; или</li><li >любой сбой в межсерверном вызове. (как правило, в <code class="xref py py-func">jsonrpc()</code>).</li></ul></section><section class="code-exception"><h6 ><code><em >exception </em>odoo.exceptions.UserError</code></h6><p >Возникает при любом неожиданном поведении по усмотрению разработчика приложения (* вы <a href="#id1"><span id="id2" class="problematic">*</span></a>).</p></section></section><section id="test-the-api"><h3 >Протестируйте API</h3><p >Чтобы протестировать разработанное приложение, мы предлагаем платформу для песочницы, которая позволяет:</p><ol ><li >Протестируйте весь поток с точки зрения клиента - Актуальные услуги и транзакции, с которыми можно ознакомиться. (опять же, это требует изменения конечной точки, см. примечание об опасности в <a href="#iap-service" class="reference internal"><span class="std std-ref">Service</span></a>).</li><li >Протестируйте API.</li></ol><p >Последний состоит из специальных токенов, которые будут работать только на ** IAP-песочнице <a href="#id1"><span id="id2" class="problematic">**</span></a>.</p><ul ><li >Токен `` 000000``: представляет несуществующую учетную запись. Возвращает <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="reference internal"><code class="xref py py-class">InsufficientCreditError</code></a> при попытке авторизации.</li><li >Токен `` 000111``: представляет учетную запись без достаточного количества кредитов для выполнения каких-либо услуг. Возвращает <a href="#odoo.addons.iap.models.iap.InsufficientCreditError" title="odoo.addons.iap.models.iap.InsufficientCreditError" class="reference internal"><code class="xref py py-class">InsufficientCreditError</code></a> при попытке авторизации.</li><li >Токен `` 111111``: представляет учетную запись с достаточным количеством кредитов для выполнения любой услуги. Попытка авторизации вернет фиктивный токен транзакции, который обрабатывается маршрутами захвата и отмены.</li></ul><div role="alert" class="alert alert-info"><h3 class="alert-title">Примечание</h3><ul ><li >Эти токены активны только на сервере IAP-Sanbox.</li><li >Служебный ключ полностью игнорируется этим потоком. Если вы хотите выполнить надежный тест своего сервиса, вы должны игнорировать эти токены.</li></ul></div></section><section id="odoo-helpers"><h2 >Помощники Odoo</h2><p >Для удобства, если вы реализуете свой сервис с использованием Odoo, модуль `` iap`` предоставляет несколько помощников, чтобы сделать поток IAP еще проще.</p></section><section id="charging"><i id="iap-charging"></i><h3 >Зарядка</h3><section class="code-class"><h6 id="odoo.addons.iap.models.iap.charge"><code><em >class </em>odoo.addons.iap.models.iap.charge(<em>env</em>, <em>key</em>, <em>account_token</em>, <em>credit</em>[, <em>dbuuid</em>, <em>description</em>, <em>credit_template</em>])</code></h6><p >A <em >context manager</em> for authorizing and automatically capturing or
cancelling transactions for use in the backend/proxy.</p><p >Работает так же, как, например, менеджер контекста курсора:</p><ul ><li >немедленно авторизует транзакцию с указанными параметрами;</li><li >выполняет тело `` with``;</li><li >если тело выполняется полностью без ошибок, фиксируется транзакция;</li><li >в противном случае отменяет это.</li></ul><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >env</strong> (<code >odoo.api.Environment</code>) – используется для получения ключа конфигурации `` iap.endpoint``</li><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li><li ><strong >token</strong> (<a href="#UserToken" title="UserToken" class="alert-link reference internal"><code >UserToken</code></a>) – </li><li ><strong >credit</strong> (<a href="https://docs.python.org/3/library/functions.html#float" title="(в Python v3.8)" class="external reference alert-link"><code >float</code></a>) – </li><li ><strong >description</strong> (<a href="https://docs.python.org/3/library/stdtypes.html#str" title="(в Python v3.8)" class="external reference alert-link"><code >str</code></a>) – </li><li ><strong >template credit_template</strong> (<code >Qweb</code>) – </li></ul></div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/deathstar/superlaser&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">superlaser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span>
                 <span class="n">coordinates</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                 <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      :param factor: superlaser power factor,</span>
<span class="sd">                     0.0 is none, 1.0 is full power</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">credits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXIMUM_POWER</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;We will demonstrate the power of this station on your home planet of Alderaan.&quot;</span>
<span class="hll">      <span class="k">with</span> <span class="n">charge</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">SERVICE_KEY</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span> <span class="k">as</span> <span class="n">transaction</span><span class="p">:</span>
</span>          <span class="c1"># TODO: allow other targets</span>
<span class="hll">          <span class="n">transaction</span><span class="o">.</span><span class="n">credit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">credits</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="hll">          <span class="c1"># Sales ongoing one the energy price,</span>
</span><span class="hll">          <span class="c1"># a maximum of 2 credits will be charged/captured.</span>
</span>          <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;systems.planets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
              <span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;M-10&#39;</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Alderaan&#39;</span><span class="p">),</span>
          <span class="p">])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</pre></div>
</div>
</section><section id="id1"><h3 >Авторизоваться</h3><section class="code-class"><h6 id="odoo.addons.iap.models.iap.authorize"><code><em >class </em>odoo.addons.iap.models.iap.authorize(<em>env</em>, <em>key</em>, <em>account_token</em>, <em>credit</em>[, <em>dbuuid</em>, <em>description</em>, <em>credit_template</em>])</code></h6><p >Разрешит все.</p><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >env</strong> (<code >odoo.api.Environment</code>) – используется для получения ключа конфигурации `` iap.endpoint``</li><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li><li ><strong >token</strong> (<a href="#UserToken" title="UserToken" class="alert-link reference internal"><code >UserToken</code></a>) – </li><li ><strong >credit</strong> (<a href="https://docs.python.org/3/library/functions.html#float" title="(в Python v3.8)" class="external reference alert-link"><code >float</code></a>) – </li><li ><strong >description</strong> (<a href="https://docs.python.org/3/library/stdtypes.html#str" title="(в Python v3.8)" class="external reference alert-link"><code >str</code></a>) – </li><li ><strong >template credit_template</strong> (<code >Qweb</code>) – </li></ul></div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/deathstar/superlaser&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">superlaser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span>
                 <span class="n">coordinates</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                 <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      :param factor: superlaser power factor,</span>
<span class="sd">                     0.0 is none, 1.0 is full power</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">credits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXIMUM_POWER</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;We will demonstrate the power of this station on your home planet of Alderaan.&quot;</span>
      <span class="c1">#actual IAP stuff</span>
<span class="hll">      <span class="n">transaction_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">SERVICE_KEY</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
</span>      <span class="k">try</span><span class="p">:</span>
          <span class="c1"># Beware the power of this laser</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">put_galactical_princess_in_sorrow</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="c1"># Nevermind ...</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">cancel</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">transaction_token</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
          <span class="k">raise</span> <span class="n">e</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="c1"># We shall rule over the galaxy!</span>
          <span class="n">capture</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">transaction_token</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">credits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</section><section id="id2"><h3 >Отмена</h3><section class="code-class"><h6 id="odoo.addons.iap.models.iap.cancel"><code><em >class </em>odoo.addons.iap.models.iap.cancel(<em>env</em>, <em>transaction_token</em>, <em>key</em>)</code></h6><p >Отменит авторизованную транзакцию.</p><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >env</strong> (<code >odoo.api.Environment</code>) – используется для получения ключа конфигурации `` iap.endpoint``</li><li ><strong >transaction_token</strong> (<a href="https://docs.python.org/3/library/stdtypes.html#str" title="(в Python v3.8)" class="external reference alert-link"><code >str</code></a>) – </li><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li></ul></div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/deathstar/superlaser&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">superlaser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span>
                 <span class="n">coordinates</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                 <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      :param factor: superlaser power factor,</span>
<span class="sd">                     0.0 is none, 1.0 is full power</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">credits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXIMUM_POWER</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;We will demonstrate the power of this station on your home planet of Alderaan.&quot;</span>
      <span class="c1">#actual IAP stuff</span>
      <span class="n">transaction_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">SERVICE_KEY</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
          <span class="c1"># Beware the power of this laser</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">put_galactical_princess_in_sorrow</span><span class="p">()</span>
<span class="hll">      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class="hll">          <span class="c1"># Nevermind ...</span>
</span><span class="hll">          <span class="n">r</span> <span class="o">=</span> <span class="n">cancel</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">transaction_token</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span class="hll">          <span class="k">raise</span> <span class="n">e</span>
</span>      <span class="k">else</span><span class="p">:</span>
          <span class="c1"># We shall rule over the galaxy!</span>
          <span class="n">capture</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">transaction_token</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">credits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</section><section id="id3"><h3 >Захватить</h3><section class="code-class"><h6 id="odoo.addons.iap.models.iap.capture"><code><em >class </em>odoo.addons.iap.models.iap.capture(<em>env</em>, <em>transaction_token</em>, <em>key</em>, <em>credit</em>)</code></h6><p >Захватит сумму <code >кредит</code> по данной транзакции.</p><div class="code-fields"><div class="code-field"><div class="code-field-name">Параметры</div><div class="code-field-body"><ul ><li ><strong >env</strong> (<code >odoo.api.Environment</code>) – используется для получения ключа конфигурации `` iap.endpoint``</li><li ><strong >transaction_token</strong> (<a href="https://docs.python.org/3/library/stdtypes.html#str" title="(в Python v3.8)" class="external reference alert-link"><code >str</code></a>) – </li><li ><strong >key</strong> (<a href="#ServiceKey" title="ServiceKey" class="alert-link reference internal"><code >ServiceKey</code></a>) – </li><li ><strong >credit</strong> – </li></ul></div></div></div></section><div class="highlight-python"><div class="highlight"><pre><span></span>  <span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/deathstar/superlaser&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">superlaser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span>
                 <span class="n">coordinates</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                 <span class="n">factor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      :param factor: superlaser power factor,</span>
<span class="sd">                     0.0 is none, 1.0 is full power</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">credits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAXIMUM_POWER</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;We will demonstrate the power of this station on your home planet of Alderaan.&quot;</span>
      <span class="c1">#actual IAP stuff</span>
      <span class="n">transaction_token</span> <span class="o">=</span> <span class="n">authorize</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">SERVICE_KEY</span><span class="p">,</span> <span class="n">user_account</span><span class="p">,</span> <span class="n">credits</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
          <span class="c1"># Beware the power of this laser</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">put_galactical_princess_in_sorrow</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
          <span class="c1"># Nevermind ...</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">cancel</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">transaction_token</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
          <span class="k">raise</span> <span class="n">e</span>
<span class="hll">      <span class="k">else</span><span class="p">:</span>
</span><span class="hll">          <span class="c1"># We shall rule over the galaxy!</span>
</span><span class="hll">          <span class="n">capture</span><span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">transaction_token</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">credits</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span></pre></div>
</div>
</section>

          </article>
        </div>
        
        <div id="mask"></div>
      </main>
  </div>

  <div class="floating_action_container">
    <a id="floating_action" class="ripple" href="#">
      <i class="mdi-action-explore"></i>
    </a>
    <div id="floating_action_menu">
      <span class="bubble"></span>
      <ul class="list-group content">
        <li class="list-group-item ripple"><a>Cras justo odio</a></li>
        <li class="list-group-item ripple"><a>Dapibus ac facilisis in</a></li>
        <li class="list-group-item ripple"><a>Morbi leo risus</a></li>
        <li class="list-group-item ripple"><a>Porta ac consectetur ac</a></li>
        <li class="list-group-item ripple"><a>Vestibulum at eros</a></li>
      </ul>
    </div>
  </div>
<!-- 
  <footer>
    <div id="footer" class="container">
      <span class="o_logo o_logo_inverse center-block o_footer_logo"></span>
      <div class="row">
        <div class="col-sm-7 col-md-7 col-lg-6">
          <div class="row">
            <div class="col-xs-6 col-sm-4">
              <span class="menu_title">Community</span>
              <ul>
                <li><a href="https://github.com/odoo/odoo">Github</a></li>
                <li><a href="http://www.odoo.com/page/download">Download</a></li>
                <li class="divider"></li>
                <li><a href="http://runbot.odoo.com/runbot/repo/git-github-com-odoo-enterprise-7">Runbot</a></li>
                <li><a href="https://github.com/odoo/odoo/wiki/Translations">Translations</a></li>
                <li class="divider"></li>
                <li><a href="http://www.odoo.com/page/odoo-community">Mailing Lists</a></li>
                <li><a href="http://www.odoo.com/forum/help-1">Forum</a></li>
              </ul>
            </div>
            <div class="col-xs-6 col-sm-4">
              <span class="menu_title">Services</span>
              <ul>
                <li><a href="https://www.odoo.sh">Odoo Cloud Platform</a></li>
                <li class="divider"></li>
                <li><a href="http://www.odoo.com/help">Support</a></li>
                <li><a href="https://upgrade.odoo.com">Upgrade</a></li>
                <li class="divider"></li>
                <li><a href="http://www.odoo.com/partners">Find a partner</a></li>
                <li><a href="http://www.odoo.com/page/become-a-partner">Become a partner</a></li>
                <li class="divider"></li>
                <li><a href="http://training.odoo.com/courses/odoo-functional">Training Center</a></li>
                <li><a href="http://www.odoo.com/page/education-program">Education</a></li>
                <li class="divider"></li>
                <li><a href="http://www.odoo.com/page/security">Security</a></li>
              </ul>
            </div>
            <div class="col-xs-12 col-sm-4 mb64">
              <span class="menu_title">About us</span>
              <ul>
                <li><a href="http://www.odoo.com/page/about-us">Our company</a></li>
                <li><a href="http://www.odoo.com/page/contactus">Contact</a></li>
                <li class="divider" />
                <li><a href="http://www.odoo.com/event">Events</a></li>
                <li><a href="http://www.odoo.com/blog">Blog</a></li>
                <li><a href="http://www.odoo.com/blog/6">Customers</a></li>
                <li class="divider" />
                <li><a href="http://www.odoo.com/jobs">Jobs</a></li>
                <li class="divider" />
                <li><a href="http://www.odoo.com/page/legal">Legal</a> | <a href="http://www.odoo.com/privacy">Privacy</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-sm-5 col-md-4 col-md-offset-1 col-lg-5 col-lg-offset-1">
          <p>
            <small>
              Odoo is a suite of open source business apps that cover all your company needs: CRM, eCommerce, accounting, inventory, point of sale, project management, etc.
              <br/><br/>
              Odoo's unique value proposition is to be at the same time very easy to use and fully integrated.
            </small>
          </p>
        </div>
      </div>
    </div>
    <div class="o_footer_bottom">
      <div class="container">
        <a class="small" href="http://www.odoo.com/page/website-builder">Website made with <span class="o_logo o_logo_inverse o_logo_15"></span></a>
        <div class="social-links pull-right">
          <a href="http://www.odoo.com/web/about/facebook"><i class="fa fa-facebook"></i></a>
          <a href="http://www.odoo.com/web/about/twitter"><i class="fa fa-twitter"></i></a>
          <a href="http://www.odoo.com/web/about/linkedin"><i class="fa fa-linkedin"></i></a>
          <a href="mailto:info@odoo.com"><i class="fa fa-envelope"></i></a>
        </div>
      </div>
    </div>
  </footer>
  -->
  </body>
</html>